- name: Update netplan renderer and DNS (minimal)
  hosts: workers
  become: true
  serial: 1
  gather_facts: false

  vars:
    netplan_file: /etc/netplan/99-netcfg-vmware.yaml
    dns1: 192.168.100.52
    dns2: 192.168.100.51

  tasks:
    - name: Set renderer to NetworkManager
      ansible.builtin.replace:
        path: "{{ netplan_file }}"
        regexp: '(^\s*renderer:\s*)networkd\s*$'
        replace: '\1NetworkManager'
        backup: true

    # thay block nameservers.addresses: - old1 - old2  (đúng kiểu file bạn đang có)
    - name: Replace nameservers addresses block (2 DNS)
      ansible.builtin.replace:
        path: "{{ netplan_file }}"
        regexp: |
          (?ms)^(\s*nameservers:\s*\n\s*addresses:\s*\n)(\s*-\s*\d{1,3}(?:\.\d{1,3}){3}\s*\n)(\s*-\s*\d{1,3}(?:\.\d{1,3}){3}\s*\n)
        replace: |
          \1  - {{ dns1 }}
            - {{ dns2 }}
        backup: true

    - name: Apply netplan
      ansible.builtin.command: netplan apply

    - name: Quick check
      ansible.builtin.shell: |
        set -o pipefail
        echo "=== renderer result ==="
        grep -n "renderer:" {{ netplan_file }}
        echo "=== DNS in file ==="
        awk '/nameservers:/,0' {{ netplan_file }} | sed -n '1,12p'
        echo "=== nmcli device status ==="
        nmcli -t -f DEVICE,STATE dev status || true
      args:
        executable: /bin/bash
      changed_when: false
 
    - name: Ensure systemd-resolved is installed/enabled
      ansible.builtin.systemd:
        name: systemd-resolved
        enabled: true
        state: started

    - name: Set DNS= in /etc/systemd/resolved.conf
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^\s*DNS='
        line: "DNS={{ resolved_dns | join(' ') }}"
        create: false
        backup: true

    - name: Set FallbackDNS= (optional)
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^\s*FallbackDNS='
        line: "FallbackDNS={{ resolved_fallback_dns | join(' ') }}"
        create: false
      when: resolved_fallback_dns | length > 0

    - name: Set Domains= (optional)
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^\s*Domains='
        line: "Domains={{ resolved_domains | join(' ') }}"
        create: false
      when: resolved_domains | length > 0

    - name: Restart systemd-resolved
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted

    # dùng stub (127.0.0.53) -> resolved sẽ forward theo DNS= bạn set
    - name: Relink /etc/resolv.conf to systemd-resolved stub
      ansible.builtin.file:
        path: /etc/resolv.conf
        state: link
        force: true
        src: /run/systemd/resolve/stub-resolv.conf

    - name: Verify DNS
      ansible.builtin.shell: |
        set -o pipefail
        echo "=== resolvectl status ==="
        resolvectl status | sed -n '1,160p'
        echo "=== /etc/resolv.conf ==="
        ls -l /etc/resolv.conf
        cat /etc/resolv.conf
      args:
        executable: /bin/bash
      changed_when: false
